# チャット機能シーケンス図

Stimulusコントローラーを使ったチャット機能と正誤判定のリアルタイム動作フロー

---

## 1. 通常チャット送信（基本フロー）

```mermaid
sequenceDiagram
    participant User as 👤 プレイヤー<br/>(A)
    participant Chat as 💬 Chat Controller
    participant Server as 🖥️ GameChannel
    participant Others as 👥 他プレイヤー

    User->>Chat: メッセージ入力「ハロー！」
    User->>Chat: Sendボタンクリック

    Chat->>Server: perform('send_message', {<br/>  message: 'ハロー！',<br/>  is_answer: false<br/>})

    Note over Server: 通常チャット<br/>(正誤判定なし)

    Server->>Chat: broadcast('chat_message')
    Server->>Others: broadcast('chat_message')

    Chat->>Chat: メッセージ追加

    Others->>Others: メッセージ追加
```

---

## 2. 回答送信と正誤判定

```mermaid
sequenceDiagram
    participant User as 👤 回答者<br/>(B)
    participant Chat as 💬 Chat Controller
    participant Server as 🖥️ GameChannel
    participant TopicService as 📝 TopicService
    participant All as 👥 全プレイヤー

    User->>Chat: メッセージ入力「りんご！」
    User->>Chat: Answerボタンクリック

    Chat->>Server: perform('send_message', {<br/>  message: 'りんご！',<br/>  is_answer: true<br/>})

    Note over Server: 正誤判定実行

    Server->>TopicService: check_answer?('りんご', 'りんご！')
    TopicService->>TopicService: 正規化処理<br/>(カタカナ→ひらがな)
    TopicService->>Server: true (正解)

    Server->>All: broadcast('correct_answer', {<br/>  player_name: 'B',<br/>  answer: 'りんご！'<br/>})

    All->>All: 正解メッセージ表示
    Note over All: 🎉 Bさんの回答<br/>「りんご！」あたり
```

---

## 3. 不正解の場合

```mermaid
sequenceDiagram
    participant User as 👤 回答者<br/>(C)
    participant Chat as 💬 Chat Controller
    participant Server as 🖥️ GameChannel
    participant TopicService as 📝 TopicService
    participant All as 👥 全プレイヤー

    User->>Chat: メッセージ入力「バナナ」
    User->>Chat: Answerボタンクリック

    Chat->>Server: perform('send_message', {<br/>  message: 'バナナ',<br/>  is_answer: true<br/>})

    Server->>TopicService: check_answer?('りんご', 'バナナ')
    TopicService->>Server: false (不正解)

    Server->>All: broadcast('incorrect_answer', {<br/>  player_name: 'C',<br/>  answer: 'バナナ'<br/>})

    All->>All: 赤色の不正解メッセージ表示
    Note over All: 😇 Cさんの回答<br/>「バナナ」残念
```

## まとめ

### 基本フロー
```
メッセージ入力
    ↓
Send / Answer ボタンクリック
    ↓
WebSocket送信 (is_answer フラグで分岐)
    ↓
サーバー側で処理
    ├─ 通常チャット → そのままブロードキャスト
    └─ 回答 → 正誤判定 → 結果をブロードキャスト
    ↓
全プレイヤーにメッセージ表示
```
