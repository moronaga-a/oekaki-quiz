# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

Action Cableï¼ˆWebSocketï¼‰ã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã®å‹•ä½œãƒ•ãƒ­ãƒ¼

---

## 1. WebSocketæ¥ç¶šã®ç¢ºç«‹ï¼ˆ1å›ã ã‘ã€æº–å‚™ï¼‰

```mermaid
sequenceDiagram
    participant Client as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ<br/>(Stimulus)
    participant Cable as Action Cable
    participant Server as ã‚µãƒ¼ãƒãƒ¼<br/>(GameChannel)
    participant Stream as ğŸ“» ã‚¹ãƒˆãƒªãƒ¼ãƒ <br/>(Room ABC123)
    participant Others as ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

    Note over Client,Others: ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼ˆãƒ«ãƒ¼ãƒ å‚åŠ æ™‚ï¼‰

    Client->>Cable: â‘  subscriptions.create()<br/>WebSocketæ¥ç¶šé–‹å§‹
    Cable->>Server: â‘¡ æ¥ç¶šãƒªã‚¯ã‚¨ã‚¹ãƒˆ

    Server->>Stream: â‘¢ stream_for room<br/>ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ç™»éŒ²
    Note over Stream: Room ABC123ã®<br/>é…ä¿¡ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ

    Server->>Cable: â‘£ æ¥ç¶šæˆåŠŸ
    Cable->>Client: â‘¤ connected()
    Client->>Client: connectionStatus = 'connected'

    Note over Client,Others: æ¥ç¶šå®Œäº†ï¼<br/>ä»¥é™ã€ã“ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§é…ä¿¡ã•ã‚Œã‚‹
```

---

## 2. å…±é€šã®é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã§åŒã˜ã€é€šä¿¡ã®ãŸã³ã«ä½•åº¦ã‚‚è¡Œã†ï¼‰

```mermaid
sequenceDiagram
    participant Client as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ<br/>(Stimulus)
    participant Cable as Action Cable
    participant Server as ã‚µãƒ¼ãƒãƒ¼<br/>(GameChannel)
    participant Stream as ğŸ“» ã‚¹ãƒˆãƒªãƒ¼ãƒ <br/>(Room ABC123)
    participant Others as ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

    Note over Client,Others: ã€å…±é€šã®é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘

    Note over Client: â‘  ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
    Client->>Cable: â‘¡ perform('action', data)
    Cable->>Server: â‘¢ WebSocketé€ä¿¡

    Note over Server: â‘£ ã‚µãƒ¼ãƒãƒ¼å´å‡¦ç†
    Server->>Server: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ

    Note over Server: â‘¤ ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«é…ä¿¡
    Server->>Stream: broadcast_to(room, result)
    Note over Stream: Room ABC123ã®<br/>ã‚¹ãƒˆãƒªãƒ¼ãƒ çµŒç”±ã§é…ä¿¡
    Stream->>Cable: â‘¥ é…ä¿¡
    Cable->>Client: WebSocketå—ä¿¡
    Cable->>Others: WebSocketå—ä¿¡

    Note over Client,Others: â‘¦ UIæ›´æ–°
    Client->>Client: received(data)
    Others->>Others: received(data)
```

**ãƒã‚¤ãƒ³ãƒˆ:** Canvasæç”»ã€ãƒãƒ£ãƒƒãƒˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ ã€ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãªã©ã€**ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã“ã®åŒã˜æµã‚Œ**ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚é•ã†ã®ã¯ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ï¼ˆ`data.type`ï¼‰ã ã‘ã§ã™ã€‚

---

## ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã¯ï¼Ÿ

**ã‚¹ãƒˆãƒªãƒ¼ãƒ  = ãƒ«ãƒ¼ãƒ å°‚ç”¨ã®é…ä¿¡ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆæ”¾é€å±€ã®ã‚ˆã†ãªã‚‚ã®ï¼‰**

```mermaid
flowchart TD
    GameChannel[GameChannel<br/>subscribed]

    Stream1[ğŸ“» ã‚¹ãƒˆãƒªãƒ¼ãƒ <br/>Room ABC123]
    Stream2[ğŸ“» ã‚¹ãƒˆãƒªãƒ¼ãƒ <br/>Room XYZ789]

    A[Player A]
    B[Player B]
    C[Player C]

    D[Player D]
    E[Player E]

    GameChannel -->|stream_for room| Stream1
    GameChannel -->|stream_for room| Stream2

    Stream1 -.è³¼èª­ä¸­.-> A
    Stream1 -.è³¼èª­ä¸­.-> B
    Stream1 -.è³¼èª­ä¸­.-> C

    Stream2 -.è³¼èª­ä¸­.-> D
    Stream2 -.è³¼èª­ä¸­.-> E

    Note1[broadcast_to ABC123]
    Note1 --> Stream1
    Note1 -.é…ä¿¡.-> A
    Note1 -.é…ä¿¡.-> B
    Note1 -.é…ä¿¡.-> C

    style Stream1 fill:#FFE4B5
    style Stream2 fill:#E0FFE0
    style Note1 fill:#FFB6C1
```

### ã‚³ãƒ¼ãƒ‰ã§è¦‹ã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ 

```ruby
# GameChannel (ã‚µãƒ¼ãƒãƒ¼å´)
class GameChannel < ApplicationCable::Channel
  def subscribed
    room = RoomStore.instance.find_room(params[:room_id])

    # â† ã“ã“ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ç™»éŒ²
    stream_for room  # Room ABC123 å°‚ç”¨ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œæˆ

    # ã“ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ çµŒç”±ã§é…ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
  end

  def draw(data)
    room = RoomStore.instance.find_room(params[:room_id])

    # â† ã“ã“ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«é…ä¿¡
    GameChannel.broadcast_to(room, {
      type: 'draw',
      draw_data: data['draw_data']
    })
    # â†‘ Room ABC123 ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ è³¼èª­è€…å…¨å“¡ã«é…ä¿¡ã•ã‚Œã‚‹
  end
end
```

---

## ã¾ã¨ã‚

### Action Cableã®åŸºæœ¬ãƒ•ãƒ­ãƒ¼
```
ã€å›³1: æ¥ç¶šç¢ºç«‹ï¼ˆ1å›ï¼‰ã€‘
æ¥ç¶šç¢ºç«‹ (subscribed)
    â†“
ğŸ“» ã‚¹ãƒˆãƒªãƒ¼ãƒ ç™»éŒ² (stream_for room)  â† ã“ã“ã§æ”¾é€å±€ã«åŠ å…¥
    â†“
æ¥ç¶šå®Œäº†

ã€å›³2: é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä½•åº¦ã‚‚ï¼‰ã€‘
ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ (perform)
    â†“
ã‚µãƒ¼ãƒãƒ¼å‡¦ç† (GameChannel)
    â†“
ğŸ“» ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«é…ä¿¡ (broadcast_to)  â† ã“ã“ã§æ”¾é€å±€çµŒç”±ã§é…ä¿¡
    â†“
å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å—ä¿¡ (received)
    â†“
UIæ›´æ–°
```

### ãƒ«ãƒ¼ãƒ åˆ†é›¢ã®ä»•çµ„ã¿
```
GameChannel
  â””â”€â”€ stream_for room
       â”œâ”€â”€ Room ABC123 (ç‹¬ç«‹ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ )
       â”‚    â”œâ”€â”€ Player A
       â”‚    â”œâ”€â”€ Player B
       â”‚    â””â”€â”€ Player C
       â””â”€â”€ Room XYZ789 (ç‹¬ç«‹ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ )
            â”œâ”€â”€ Player D
            â””â”€â”€ Player E
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§
```
Action Cable:
  - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: 50-200ms (ä¸­ç¨‹åº¦)
  - é©ç”¨ç¯„å›²: ãƒãƒ£ãƒƒãƒˆã€çŠ¶æ…‹åŒæœŸã€é€šçŸ¥
  - åˆ¶ç´„: é«˜é »åº¦æ›´æ–°ã¯ä¸å¾—æ„

Socket.io:
  - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: 10-50ms (ä½ã„)
  - é©ç”¨ç¯„å›²: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ ã€æç”»åŒæœŸ
  - åˆ¶ç´„: åˆ¥ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦
```

### ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã¨ã®é€£æº
```
GameState (ãƒ¢ãƒ‡ãƒ«å±¤)
  status: :waiting â†’ :playing â†’ :finished
          â†“          â†“          â†“
    broadcast  broadcast  broadcast
          â†“          â†“          â†“
    Action Cable ã§å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é…ä¿¡
          â†“          â†“          â†“
    å…¨å“¡ã®UIãŒåŒã˜çŠ¶æ…‹ã«æ›´æ–°ã•ã‚Œã‚‹
```
